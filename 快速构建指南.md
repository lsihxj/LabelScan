# Windows独立部署版本构建指南

本文档介绍如何构建可独立部署的Windows版本。

## 前置要求

### 开发环境
- Windows 10/11 (64位)
- Python 3.10 或更高版本
- Node.js 18+ 
- Tesseract OCR 5.3+

### Python依赖
确保已安装所有运行时依赖：
```bash
pip install -r requirements.txt
```

### 构建工具依赖
安装PyInstaller用于打包：
```bash
pip install -r build_requirements.txt
```

## 构建步骤

### 方法一: 使用自动构建脚本 (推荐)

运行自动化构建脚本，一键完成所有步骤：

```bash
python build_windows.py
```

构建脚本会自动执行以下操作：
1. 清理旧的构建文件
2. 构建前端 (npm install && npm run build)
3. 安装PyInstaller
4. 打包后端为可执行文件
5. 复制配置文件和依赖
6. 创建启动脚本
7. 生成发布压缩包

### 方法二: 手动构建

如果需要手动控制每个步骤：

#### 1. 构建前端
```bash
cd frontend
npm install
npm run build
cd ..
```

#### 2. 安装打包工具
```bash
pip install pyinstaller
```

#### 3. 打包后端
```bash
pyinstaller build.spec --clean
```

#### 4. 手动整理文件
将以下文件复制到 `dist/LabelScan/` 目录：
- config/ (配置文件目录)
- frontend/dist/ (前端构建产物)
- README.md

创建以下目录：
- logs/ (日志目录)
- temp/ (临时文件)
- uploads/ (上传文件)

## 构建产物

构建完成后，会生成以下内容：

### 程序目录 (dist/LabelScan/)
```
LabelScan/
├── LabelScan.exe          # 主程序
├── start.bat              # 启动脚本
├── README_部署说明.txt     # 部署说明
├── config/                # 配置文件
│   ├── system.yaml
│   ├── processing.yaml
│   ├── ai.yaml
│   └── logging.yaml
├── frontend/              # 前端文件
│   └── dist/
├── logs/                  # 日志目录
├── temp/                  # 临时文件目录
├── uploads/               # 上传文件目录
└── [其他依赖文件...]
```

### 发布包 (release/)
```
release/
└── LabelScan_Windows_v1.0.0.zip  # 可分发的完整压缩包
```

## 部署到目标机器

### 1. 解压程序包
将 `LabelScan_Windows_v1.0.0.zip` 解压到任意目录，例如：
```
D:\LabelScan\
```

### 2. 安装Tesseract OCR

Tesseract OCR是必需的组件，用于文字识别。

#### 下载和安装
1. 访问: https://github.com/UB-Mannheim/tesseract/wiki
2. 下载Windows安装包 (推荐64位版本)
3. 运行安装程序
4. **重要**: 安装时勾选中文语言包 `Chinese - Simplified (chi_sim)`
5. 记住安装路径，例如: `C:\Program Files\Tesseract-OCR\tesseract.exe`

#### 配置Tesseract路径
编辑 `config\system.yaml` 文件，找到以下配置：

```yaml
ocr:
  local:
    tesseract_cmd: "C:\\Program Files\\Tesseract-OCR\\tesseract.exe"
```

将路径修改为实际安装路径。

**注意**: Windows路径中的反斜杠需要使用双反斜杠 `\\`

### 3. 启动系统

双击运行 `start.bat` 即可启动系统。

启动成功后，会显示：
```
========================================
  电子标签多条码识别系统
========================================

正在启动服务器...

INFO:     Started server process
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8000
```

### 4. 访问系统

在浏览器中打开：
- 主界面: http://localhost:8000
- API文档: http://localhost:8000/docs

## 配置说明

### 系统配置 (config/system.yaml)
```yaml
# 服务器配置
server:
  host: "0.0.0.0"      # 监听地址
  port: 8000           # 端口号

# OCR配置
ocr:
  local:
    tesseract_cmd: "C:\\Program Files\\Tesseract-OCR\\tesseract.exe"
    lang: "eng+chi_sim"  # 语言包
```

### 处理配置 (config/processing.yaml)
配置图像处理参数，如识别模式、排序规则等。

### AI配置 (config/ai.yaml)
配置AI识别服务，如OpenAI、Moonshot等。

### 日志配置 (config/logging.yaml)
配置日志级别、文件位置等。

## 常见问题

### 1. 启动失败：端口被占用
**错误**: `Error: [Errno 10048] Only one usage of each socket address...`

**解决**: 
- 修改 `config/system.yaml` 中的端口号
- 或者关闭占用8000端口的其他程序

### 2. OCR识别失败
**错误**: `TesseractNotFoundError`

**解决**:
- 确认Tesseract已正确安装
- 检查 `config/system.yaml` 中的路径配置
- 确保中文语言包已安装

### 3. 前端页面无法加载
**错误**: 浏览器显示404或空白页

**解决**:
- 确认 `frontend/dist` 目录存在
- 重新构建前端: `cd frontend && npm run build`
- 检查 `dist/LabelScan/frontend/dist/` 是否包含完整文件

### 4. AI识别不可用
**原因**: 未配置AI服务

**解决**:
- 在Web界面的"AI设置"中配置API密钥
- 或编辑 `config/ai.yaml` 手动配置

## 优化建议

### 减小程序体积
1. 删除不需要的语言包
2. 使用UPX压缩exe文件
3. 排除不必要的Python库

### 提高启动速度
1. 使用SSD存储
2. 关闭不必要的杀毒软件扫描
3. 预加载常用模型

### 安全加固
1. 配置防火墙规则
2. 使用HTTPS (需要配置SSL证书)
3. 限制访问IP范围

## 技术支持

如遇到问题：
1. 查看 `logs/app.log` 了解详细日志
2. 查看 `logs/error.log` 了解错误信息
3. 参考README.md中的文档

## 更新和维护

### 更新程序
1. 备份 `config` 目录
2. 解压新版本程序
3. 恢复配置文件
4. 重启服务

### 数据备份
建议定期备份以下内容：
- config/ (配置)
- uploads/ (上传的图像)
- logs/ (日志文件)

---

**版本**: 1.0.0  
**最后更新**: 2024
